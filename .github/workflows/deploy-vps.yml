name: Deploy to Hostinger VPS

# ================================================================
# Se dÃ©clenche automatiquement Ã  chaque push sur main
# OU manuellement via GitHub > Actions > Run workflow
# ================================================================

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "ðŸ”„ Deploying La Bible de l'IA..."

            SITE_DIR="/var/www/labibledelia.com"

            # Pull latest changes
            cd "$SITE_DIR"
            git pull origin main

            # Set correct permissions
            chown -R www-data:www-data "$SITE_DIR"
            chmod -R 755 "$SITE_DIR"

            # Protect PHP files
            if [ -f "$SITE_DIR/api/submit.php" ]; then
              chmod 644 "$SITE_DIR/api/submit.php"
            fi

            # Reload Nginx (graceful, no downtime)
            nginx -t && systemctl reload nginx

            echo "âœ… Deploy complete!"
